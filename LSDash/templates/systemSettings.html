{% extends "global/base.html" %}
{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'LSDash/css/style-systemSettings.css' %}">
<link rel="icon" type="image/x-icon" href="{% static 'LSDash/img/favicon.ico' %}">
<style>
    /* Ajuste para a tabela com conteúdo centralizado */
    .table th, .table td {
        text-align: center;
        vertical-align: middle;
        padding: 12px 15px; /* Aumentando o espaçamento nas células da tabela */
    }

    /* Outros ajustes */
    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th {
        background-color: #f8f9fc;
        font-weight: bold;
    }

    /* Ajuste para a estrutura das divs */
    .usuarios-logados-container {
        margin-top: 20px;
    }

    .card-body {
        padding: 20px;
    }
</style>
{% endblock style %}

{% block page-content %}
<header>
  {% include "global/partials/navbar.html" %}
</header>

<div id="webcrumbs" class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Parâmetros do Sistema</h1>
        <div class="ml-auto d-flex gap-3">
            <button id="btn-redefinir" class="bg-slate-200 hover:bg-slate-300 text-slate-700 transition-all px-6 py-2 rounded-full">
                Redefinir
            </button>
            <button id="btn-salvar" class="bg-teal-500 hover:bg-teal-600 text-white transition-all px-6 py-2 rounded-full">
                Salvar
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Usuários Logados -->
        <div class="bg-white rounded-2xl shadow-md overflow-hidden border-2 border-slate-100">
            <div class="bg-slate-50 p-4 font-semibold text-center text-slate-800">
                Usuários Logados
            </div>
            <div class="p-4 usuarios-logados-container">
                <!-- Box de Usuários Ativos -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Usuários Ativos</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="dataTableUsuariosAtivos" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Usuário</th>
                                        <th>Início</th>
                                        <th>Última Atividade</th>
                                        <th>IP</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for sessao in sessoes_ativas %}
                                    <tr>
                                        <td>
                                            {% if sessao.usuario.user_img %}
                                                <img src="{{ sessao.usuario.user_img.url }}" alt="{{ sessao.usuario.username }}" 
                                                     class="rounded-circle mr-2" style="width: 30px; height: 30px;">
                                            {% endif %}
                                            {{ sessao.usuario.username }}
                                        </td>
                                        <td>{{ sessao.data_inicio|date:"d/m/Y H:i" }}</td>
                                        <td>{{ sessao.ultima_atividade|date:"d/m/Y H:i" }}</td>
                                        <td>{{ sessao.endereco_ip }}</td>
                                        <td>
                                            <form method="post" action="{% url 'encerrar_sessao' sessao.id %}">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-danger">
                                                    <i class="fas fa-sign-out-alt"></i> Deslogar
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-slate-500">Nenhum usuário ativo.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Box de Deslogar Usuário -->
                <div class="bg-slate-50 rounded-lg p-4">
                    <div class="font-semibold text-slate-800 mb-2">Deslogar Usuário</div>
                    <div class="flex items-center gap-2">
                        <div class="text-sm text-slate-600">Cód:</div>
                        <input type="text" class="flex-1 border border-slate-300 rounded-md h-8 px-2 text-sm" />
                        <button class="btn-aplicar bg-teal-500 hover:bg-teal-600 text-white transition-all px-4 py-1 rounded-full text-sm">
                            Aplicar
                        </button>
                    </div>
                </div>

                <!-- Box de Permanência em Inatividade -->
                <div class="bg-slate-50 rounded-lg p-3">
                    <div class="text-center text-slate-800 font-medium mb-2">
                        Permanência em Inatividade
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-sm text-slate-600">Tempo:</div>
                        <input type="text" id="input-tempo-inatividade" class="flex-1 border border-slate-300 rounded-md h-8 px-2 text-sm" value="00:45" />
                        <button class="btn-aplicar bg-teal-500 hover:bg-teal-600 text-white transition-all px-4 py-1 rounded-full text-sm">
                            Aplicar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Imagens da Home -->
        <!--
        <div class="bg-white rounded-2xl shadow-md overflow-hidden border-2 border-slate-100">
            <div class="bg-slate-50 p-4 font-semibold text-center text-slate-800">
                Imagens da Home
            </div>
            <div class="p-4">
                {% for i in "12" %}
                <div class="mb-4">
                    <div class="mb-2 text-slate-800 font-medium">{{ forloop.counter }}ª Imagem</div>
                    <div class="flex items-center gap-3">
                        <div class="flex-1 bg-slate-100 rounded-lg h-24 flex items-center justify-center">
                            <span class="material-symbols-outlined text-5xl text-slate-400" aria-label="Upload de imagem">upload</span>
                        </div>
                        <div>
                            <input type="file" id="upload{{ forloop.counter }}" class="hidden" />
                            <button onclick="document.getElementById('upload{{ forloop.counter }}').click()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 transition-all px-4 py-1 rounded-full text-sm w-24 mb-2">
                                Carregar
                            </button>
                            <button class="btn-aplicar bg-teal-500 hover:bg-teal-600 text-white transition-all px-4 py-1 rounded-full text-sm w-24">
                                Aplicar
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div class="text-sm text-slate-600 italic" title="A imagem deve ter YYYY x YYYY">OBS: A imagem deve ter tamanho adequado</div>
            </div>
        </div>
        -->

        <!-- Imagens da Home (MODIFICADO) -->
        <div class="bg-white rounded-2xl shadow-md overflow-hidden border-2 border-slate-100">
            <div class="bg-slate-50 p-4 font-semibold text-center text-slate-800">
                Imagens da Home
            </div>
            <div class="p-4">
                {% for i in "12" %}
                <div class="mb-6">
                    <div class="mb-2 text-slate-800 font-medium">{{ forloop.counter }}ª Imagem</div>
                    
                    
                    <div class="flex items-start gap-4">
                        <!-- Inputs e Botões -->
                        <div class="flex flex-col gap-2 w-48">
                            <!-- Input de arquivo escondido -->
                            

                            
                            <!--Botão escondido-->
                            <input 
                            type="file" 
                            id="upload{{ forloop.counter }}" 
                            accept="image/*"
                            style="position: absolute; left: -9999px;"
                            onchange="previewImage(event, {{ forloop.counter }})"
                            />

                            <button onclick="document.getElementById('upload{{ forloop.counter }}').click()" 
                                    class="bg-slate-200 hover:bg-slate-300 text-slate-700 transition-all px-4 py-1 rounded-full text-sm w-full">
                                Escolher arquivo
                            </button>
                            <button class="btn-aplicar bg-teal-500 hover:bg-teal-600 text-white transition-all px-4 py-1 rounded-full text-sm w-full">
                                Aplicar
                            </button>
                        </div>

                        <!-- Preview da Imagem (agora dinâmico) -->
                        <div class="flex-1 bg-slate-100 rounded-lg h-24 flex items-center justify-center overflow-hidden" id="preview{{ forloop.counter }}">
                            <span class="material-symbols-outlined text-5xl text-slate-400">upload</span>
                        </div> 
                        
                        
                    </div>

                </div>
                {% endfor %}
                <!-- Observação Específica -->
                <div class="text-sm text-slate-600 italic mt-2">
                    OBS: A imagem deve ter 500 x 500 pixels.
                </div>
            </div>
        </div>

        <!-- Observações do Administrador -->
        <div class="bg-white rounded-2xl shadow-md overflow-hidden border-2 border-slate-100 lg:col-span-2">
            <div class="bg-slate-50 p-4 font-semibold text-center text-slate-800">
                Observações do Administrador
            </div>
            <div class="p-4">
                <textarea class="w-full h-24 bg-slate-100 rounded-lg p-4 resize-none" placeholder="Digite suas observações aqui..."></textarea>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        // Barra de progresso dinâmica
        const usuariosAtivos = 4;
        const totalUsuarios = 10;
        const percentual = (usuariosAtivos / totalUsuarios) * 100;
        $('.barra-progresso').css('width', `${percentual}%`);

        // Redefinir campos
        $('#btn-redefinir').on('click', function () {
            $('input[type="text"]').val('');
            $('textarea').val('');
            alert('Os campos foram redefinidos!');
        });

        // Simular salvamento
        $('#btn-salvar').on('click', function () {
            alert('As configurações foram salvas com sucesso!');
        });

        // Validação e aplicação de dados
        $('.btn-aplicar').on('click', function () {
            const input = $(this).siblings('input[type="text"]').val();
            const isTimeInput = $(this).siblings('input').attr('id') === 'input-tempo-inatividade';
            const regexTime = /^\d{2}:\d{2}$/;

            if (!input) {
                alert('Por favor, insira um valor antes de aplicar.');
            } else if (isTimeInput && !regexTime.test(input)) {
                alert('Formato inválido. Use o padrão HH:MM.');
            } else {
                alert(`Valor aplicado: ${input}`);
            }
        });
    });
</script>

<script>
    // ===== [NOVO] Preview de Imagem + Validação de Tamanho =====
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const previewId = 'preview' + this.id.replace('upload', '');
            const preview = document.getElementById(previewId);

            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        if (this.width === 500 && this.height === 500) {
                            // Se a imagem for 500x500px, mostra o preview
                            preview.innerHTML = `<img src="${event.target.result}" class="w-full h-full object-cover" />`;
                        } else {
                            // Se não for, exibe alerta e reseta o preview
                            alert('A imagem deve ter exatamente 500x500 pixels!');
                            preview.innerHTML = '<span class="material-symbols-outlined text-5xl text-slate-400">upload</span>';
                            e.target.value = ''; // Limpa o input
                        }
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    });

</script>
{% endblock %}
