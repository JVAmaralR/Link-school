
{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    {% csrf_token %}

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Prova - Modal Corrigido</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static "LSCliente/css/style-criar-prova.css"%}" />
    <link rel="stylesheet" href="{% static "global/css/cliente-navbar.css" %}">
</head>
<body>
    {% include "global/partials/cliente_navbar.html" %}
  <div class="container-main">
        <div class="aside">
            <h1>Criação <br> de <br> <span>Provas</span></h1>
            <div class="container-buttons">
                <button class="btn-custom" type="button" onclick="salvarProva()">
                    <i class="fas fa-floppy-disk"></i>
                    <p>Salvar Prova</p>
                </button>
                <button class="btn-custom" onclick="">
                    <i class="fas fa-file-pdf"></i>
                    <p>Exportar PDF</p>
                </button>
                <button class="btn-custom" onclick="">
                    <i class="fas fa-file-word"></i>
                    <p>Exportar DOC</p>
                </button>
                <button class="btn-custom width-full" onclick="abrirModalNovaQuestao()">
                    <i class="fas fa-plus-circle"></i>
                    <p>Criar Nova Questão</p>
                </button>
                <button class="btn-custom" onclick="gerarTodasImagensProva()">
                    <i class="fas fa-magic"></i>
                    <p>Gerar Imagens IA</p>
                </button>
            </div>
        </div>
        
        <div class="settings">
            <div class="container__settings-test">
                <div class="settings__content">
                    <div class="header">
                        <div class="header__icon">
                            <i class="fas fa-cog"></i>
                            <p>Configurações da Prova</p>
                        </div>
                        <p class="header__text"><span>*</span> : Campo obrigatório</p>
                    </div>
                    <form class="form" id="form-prova">
                        {% csrf_token %}

                        <div class="form__title-test">
                            <span>*</span>
                            <input type="text" id="titulo" placeholder="Título da Prova" required />
                        </div>

                        <div class="form__matter-test">
                            <span>*</span>
                            <input type="text" id="materia" placeholder="Matéria" required />
                        </div>

                        <div class="form__type-test">
                            <span>*</span>
                            <div class="form__type-test__content">
                                <label for="tipo_prova">Tipo de Prova:</label>
                                <select id="tipo_prova" required>
                                    <option value="">Selecione</option>
                                    <option value="av1">Primeira Avaliação</option>
                                    <option value="av2">Segunda Avaliação</option>
                                    <option value="recuperacao">Recuperação</option>
                                    <option value="final">Prova Final</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="preview">
                <div class="header">
                    <div class="header__icon">
                        <i class="fas fa-eye"></i>
                        <p>Preview da Prova</p>
                    </div>
                </div>
                <div class="preview__test">
                    <div class="preview__test-content">
                        {% if config_cliente.imagem_home_1 %}
                            <div class="logo">
                                <img src="{{ config_cliente.imagem_home_1.url }}" alt="Logo" />
                            </div>
                        {% endif %}
                        <div class="preview-content__texts">
                            <div class="background-input">
                                <p><strong>Título da Prova:</strong> <span id="preview-titulo">___________________</span></p>
                            </div>
                            <div class="background-input">
                                <p><strong>Matéria:</strong> <span id="preview-materia">___________________</span></p>
                            </div>
                            <div class="background-input">
                                <p><strong>Tipo:</strong> <span id="preview-tipo">___________________</span></p>
                            </div>
                            <div class="background-input">
                                <p><strong>Nome:</strong> ___________________</p>
                            </div>
                            <div class="background-input">
                                <p><strong>Data:</strong> ___________________</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="accessibility-section">
                    <p>Nível de Acessibilidade da Prova:</p>
                    <div class="accessibility-options">
                        <div class="accessibility-option">
                            <input type="radio" id="grupo1" name="acessibilidade_prova" value="1" checked>
                            <label for="grupo1">Grau 1</label>
                        </div>
                        <div class="accessibility-option">
                            <input type="radio" id="grupo2" name="acessibilidade_prova" value="2">
                            <label for="grupo2">Grau 2</label>
                        </div>
                        <div class="accessibility-option">
                            <input type="radio" id="grupo3" name="acessibilidade_prova" value="3">
                            <label for="grupo3">Grau 3</label>
                        </div>
                    </div>
                </div>
                
                <div id="questoes-preview">
                    <p class="text-center text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Adicione questões para visualizar o preview da prova
                    </p>
                </div>
                
                <div class="add-question-area" onclick="abrirModalSelecionarQuestoes()">
                    <div class="add-icon">+</div>
                    <div class="add-text">Clique para adicionar questões</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA SELECIONAR QUESTÕES EXISTENTES -->
    <div class="modal fade" id="modalSelecionarQuestoes" tabindex="-1" aria-labelledby="modalSelecionarQuestoesLabel" aria-hidden="true">
        <div class="modal-dialog modal-questoes modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalSelecionarQuestoesLabel">
                        <i class="fas fa-question-circle text-primary"></i>
                        Selecionar Questões para a Prova
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input
                                type="text"
                                class="form-control"
                                id="search-questoes-modal"
                                placeholder="Buscar por título, matéria ou tipo..."
                                onkeyup="filtrarQuestoesModal()"
                            />
                        </div>
                    </div>

                    <div class="questoes-grid" id="questoes-grid">
                        <!-- As questões estáticas serão inseridas aqui via JavaScript -->
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="me-auto">
                        <span class="text-muted">
                            <span id="questoes-selecionadas-count">0</span> questão(ões) selecionada(s)
                        </span>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarSelecaoQuestoes()">
                        <i class="fas fa-check"></i> Adicionar Selecionadas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CRIAR NOVA QUESTÃO -->
    <div class="modal fade" id="modalNovaQuestao" tabindex="-1" aria-labelledby="modalNovaQuestaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNovaQuestaoLabel">Criar Nova Questão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <form id="form-nova-questao">
                        <div class="mb-3">
                            <label for="nova-titulo" class="form-label">Enunciado da Questão *</label>
                            <textarea class="form-control" id="nova-titulo" name="titulo" rows="3" required></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="nova-materia" class="form-label">Matéria *</label>
                                <input type="text" class="form-control" id="nova-materia" name="materia" required />
                            </div>
                            <div class="col-md-6">
                                <label for="nova-tipo" class="form-label">Tipo de Questão *</label>
                                <select class="form-select" id="nova-tipo" name="tipo" required onchange="toggleTipoQuestao()">
                                    <option value="">Selecione</option>
                                    <option value="aberta">Questão Aberta</option>
                                    <option value="multipla">Múltipla Escolha</option>
                                    <option value="vf">Verdadeiro ou Falso</option>
                                </select>
                            </div>
                        </div>

                        <div id="alternativas-section" style="display: none" class="mt-3">
                            <h6>Alternativas</h6>
                            <div id="alternativas-container">
                                <div class="alternativa-input mb-2">
                                    <div class="input-group">
                                        <span class="input-group-text">a)</span>
                                        <input type="text" class="form-control" name="alternativas[]" placeholder="Digite a alternativa" />
                                        <div class="input-group-text">
                                            <input type="radio" name="correta" value="0" title="Marcar como correta" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="adicionarAlternativa()">
                                <i class="fas fa-plus"></i> Adicionar Alternativa
                            </button>
                        </div>

                        <div id="vf-section" style="display: none" class="mt-3">
                            <h6>Frases</h6>
                            <div id="frases-container">
                                <div class="frase-input mb-2">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="frases[]" placeholder="Digite a frase" />
                                        <select class="form-select" name="verdadeira[]" style="max-width: 120px">
                                            <option value="1">Verdadeiro</option>
                                            <option value="0">Falso</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="adicionarFrase()">
                                <i class="fas fa-plus"></i> Adicionar Frase
                            </button>
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovaQuestao()">Salvar Questão</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div class="loading">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
 <script>
        // QUESTÕES ESTÁTICAS TODAS DO 9º ANO - SEM NÍVEL DE ACESSIBILIDADE PRÉ-DEFINIDO
        const questoesEstaticas = [
            {
                id: 1,
                titulo: "Resolva a equação do 2º grau: x² - 5x + 6 = 0",
                materia: "Matemática",
                tipo: "multipla",
                get_tipo_display: "Múltipla Escolha",
                ano_escolar: "9º Ano",
                grupo_ensino: "Ensino Fundamental",
                 imagem_gerada: null, 
                 gerando_imagem: false, 
                alternativas: [
                    { texto: "x = 2 e x = 3", correta: true },
                    { texto: "x = 1 e x = 6", correta: false },
                    { texto: "x = -2 e x = -3", correta: false },
                    { texto: "x = 0 e x = 5", correta: false }
                ]
            },
            {
                id: 2,
                titulo: "Sobre as características dos seres vivos, analise as afirmações:",
                materia: "Biologia",
                tipo: "vf",
                get_tipo_display: "Verdadeiro ou Falso",
                ano_escolar: "9º Ano",
                grupo_ensino: "Ensino Fundamental",
                 imagem_gerada: null, 
gerando_imagem: false, 
                frases_vf: [
                    { texto: "Todos os seres vivos são compostos por células", verdadeira: true },
                    { texto: "A reprodução é uma característica exclusiva dos animais", verdadeira: false },
                    { texto: "O crescimento é uma propriedade comum a todos os seres vivos", verdadeira: true },
                    { texto: "Apenas os animais respondem a estímulos do ambiente", verdadeira: false }
                ]
            },
            {
                id: 3,
                titulo: "Explique o conceito de densidade e como ela pode ser calculada. Dê um exemplo prático de aplicação da densidade no cotidiano.",
                materia: "Física",
                tipo: "aberta",
                get_tipo_display: "Questão Aberta",
                ano_escolar: "9º Ano",
                grupo_ensino: "Ensino Fundamental",
                imagem_gerada: null, 
gerando_imagem: false, 
            },
            {
                id: 4,
                titulo: "Qual foi o principal objetivo da Proclamação da República no Brasil?",
                materia: "História",
                tipo: "multipla",
                get_tipo_display: "Múltipla Escolha",
                ano_escolar: "9º Ano",
                grupo_ensino: "Ensino Fundamental",
                imagem_gerada: null, 
gerando_imagem: false, 
                alternativas: [
                    { texto: "Acabar com a monarquia e estabelecer um governo republicano", correta: true },
                    { texto: "Abolir a escravidão no país", correta: false },
                    { texto: "Conquistar a independência de Portugal", correta: false },
                    { texto: "Criar o sistema federativo", correta: false }
                ]
            },
            {
                id: 5,
                titulo: "Sobre as figuras de linguagem, verifique as afirmações:",
                materia: "Português",
                tipo: "vf",
                get_tipo_display: "Verdadeiro ou Falso",
                ano_escolar: "9º Ano",
                grupo_ensino: "Ensino Fundamental",
                imagem_gerada: null, 
gerando_imagem: false, 
                frases_vf: [
                    { texto: "A metáfora é uma comparação implícita entre dois elementos", verdadeira: true },
                    { texto: "A ironia expressa sempre o contrário do que se pensa", verdadeira: false },
                    { texto: "A personificação atribui características humanas a seres inanimados", verdadeira: true },
                    { texto: "O eufemismo é usado para suavizar uma expressão", verdadeira: true }
                ]
            },
            {
                id: 6,
                titulo: "Descreva as principais características do relevo brasileiro e explique como a ação do homem tem modificado a paisagem natural.",
                materia: "Geografia",
                tipo: "aberta",
                get_tipo_display: "Questão Aberta",
                ano_escolar: "9º Ano",
                grupo_ensino: "Ensino Fundamental",
                imagem_gerada: null, 
gerando_imagem: false, 
            },
            {
                id: 7,
                titulo: "Qual é o resultado de (3x + 2)² - (2x - 1)²?",
                materia: "Matemática",
                tipo: "multipla",
                get_tipo_display: "Múltipla Escolha",
                ano_escolar: "9º Ano",
                grupo_ensino: "Ensino Fundamental",
                imagem_gerada: null, 
gerando_imagem: false, 
                alternativas: [
                    { texto: "5x² + 16x + 3", correta: true },
                    { texto: "9x² + 12x + 4", correta: false },
                    { texto: "x² + 16x + 3", correta: false },
                    { texto: "5x² + 4x + 3", correta: false }
                ]
            },
            {
                id: 8,
                titulo: "Sobre as reações químicas e balanceamento de equações:",
                materia: "Química",
                tipo: "vf",
                get_tipo_display: "Verdadeiro ou Falso",
                ano_escolar: "9º Ano",
                grupo_ensino: "Ensino Fundamental",
                imagem_gerada: null, 
gerando_imagem: false, 
                frases_vf: [
                    { texto: "Uma reação química sempre produz novas substâncias", verdadeira: true },
                    { texto: "O balanceamento garante a conservação da massa", verdadeira: true },
                    { texto: "Na combustão, sempre há liberação de energia", verdadeira: true },
                    { texto: "Catalisadores alteram o resultado final da reação", verdadeira: false }
                ]
            },
            {
                id: 9,
                titulo: "Analise o uso das tecnologias na sociedade atual e seus impactos positivos e negativos. Como podemos usar a tecnologia de forma responsável?",
                materia: "Sociologia",
                tipo: "aberta",
                get_tipo_display: "Questão Aberta",
                ano_escolar: "9º Ano",
                grupo_ensino: "Ensino Fundamental",
                imagem_gerada: null, 
gerando_imagem: false, 
            },
            {
                id: 10,
                titulo: "Qual é a principal função do sistema cardiovascular?",
                materia: "Biologia",
                tipo: "multipla",
                get_tipo_display: "Múltipla Escolha",
                ano_escolar: "9º Ano",
                grupo_ensino: "Ensino Fundamental",
                imagem_gerada: null, 
gerando_imagem: false, 
                alternativas: [
                    { texto: "Transportar nutrientes e oxigênio pelo corpo", correta: true },
                    { texto: "Produzir hormônios para o crescimento", correta: false },
                    { texto: "Filtrar toxinas do organismo", correta: false },
                    { texto: "Controlar a temperatura corporal", correta: false }
                ]
            }
        ];
        
        const palavrasChave = {
    'matemática': ['equação', 'resultado', 'resolver', 'calcular', 'x²', 'grau'],
    'biologia': ['seres vivos', 'células', 'reprodução', 'características', 'animais'],
    'física': ['densidade', 'calcular', 'aplicação', 'conceito'],
    'história': ['proclamação', 'república', 'objetivo', 'brasil'],
    'português': ['figuras de linguagem', 'metáfora', 'ironia', 'personificação'],
    'geografia': ['relevo', 'brasileiro', 'características', 'paisagem'],
    'química': ['reações químicas', 'balanceamento', 'substâncias', 'massa'],
    'sociologia': ['tecnologias', 'sociedade', 'impactos', 'responsável']
};

        let questoesSelecionadas = [];
        let questoesSelecionadasTemp = [];

        // Função para carregar questões estáticas no modal
        function carregarQuestoesModal() {
            const container = document.getElementById('questoes-grid');
            let html = '';

            questoesEstaticas.forEach(questao => {
                html += `
                    <div class="questao-card-modal" 
                         data-id="${questao.id}" 
                         data-titulo="${questao.titulo}" 
                         data-materia="${questao.materia}" 
                         data-tipo="${questao.tipo}" 
                         onclick="toggleQuestaoSelecao(${questao.id}, this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 text-primary">${questao.titulo.length > 60 ? questao.titulo.substring(0, 60) + '...' : questao.titulo}</h6>
                                <div class="d-flex flex-wrap gap-1 mb-2">
                                    <span class="badge bg-secondary">${questao.materia}</span>
                                    <span class="badge bg-info">${questao.get_tipo_display}</span>
                                </div>
                                <small class="text-muted">${questao.ano_escolar} - ${questao.grupo_ensino}</small>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-check-circle text-success" style="display: none;"></i>
                                <i class="fas fa-plus-circle text-primary"></i>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (questoesEstaticas.length === 0) {
                html = `
                    <div class="col-12 text-center text-muted p-4">
                        <i class="fas fa-question-circle fa-3x mb-3"></i>
                        <p>Nenhuma questão disponível no banco de dados</p>
                        <small>Crie algumas questões primeiro para poder adicioná-las às provas</small>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Atualiza preview quando campos são alterados
        document.getElementById('titulo').addEventListener('input', function() {
            document.getElementById('preview-titulo').textContent = this.value || 'Título da Prova';
        });

        document.getElementById('materia').addEventListener('input', function() {
            document.getElementById('preview-materia').textContent = this.value || '-';
        });

        document.getElementById('tipo_prova').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            document.getElementById('preview-tipo').textContent = selectedOption.text || '-';
        });

        function abrirModalSelecionarQuestoes() {
            questoesSelecionadasTemp = [...questoesSelecionadas];
            carregarQuestoesModal();
            atualizarVisualizacaoModal();
            const modal = new bootstrap.Modal(document.getElementById('modalSelecionarQuestoes'));
            modal.show();
        }
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                getCookie('csrftoken');
        }

        // Função auxiliar para obter cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function toggleQuestaoSelecao(questaoId, element) {
            const index = questoesSelecionadasTemp.findIndex(q => q.id == questaoId);
            const icons = element.querySelectorAll('i');
            const checkIcon = icons[0];
            const plusIcon = icons[1];
            
            if (index > -1) {
                questoesSelecionadasTemp.splice(index, 1);
                element.classList.remove('selecionada');
                checkIcon.style.display = 'none';
                plusIcon.style.display = 'block';
            } else {
                const questaoData = questoesEstaticas.find(q => q.id == questaoId);
                if (questaoData) {
                    questoesSelecionadasTemp.push({...questaoData});
                    element.classList.add('selecionada');
                    checkIcon.style.display = 'block';
                    plusIcon.style.display = 'none';
                }
            }
            
            atualizarContadorSelecao();
        }

        function atualizarVisualizacaoModal() {
            const cards = document.querySelectorAll('.questao-card-modal');
            cards.forEach(card => {
                const questaoId = card.dataset.id;
                const isSelected = questoesSelecionadasTemp.some(q => q.id == questaoId);
                const icons = card.querySelectorAll('i');
                const checkIcon = icons[0];
                const plusIcon = icons[1];
                
                if (isSelected) {
                    card.classList.add('selecionada');
                    checkIcon.style.display = 'block';
                    plusIcon.style.display = 'none';
                } else {
                    card.classList.remove('selecionada');
                    checkIcon.style.display = 'none';
                    plusIcon.style.display = 'block';
                }
            });
            atualizarContadorSelecao();
        }

        function atualizarContadorSelecao() {
            document.getElementById('questoes-selecionadas-count').textContent = questoesSelecionadasTemp.length;
        }

        function filtrarQuestoesModal() {
            const searchTerm = document.getElementById('search-questoes-modal').value.toLowerCase();
            const questoes = document.querySelectorAll('.questao-card-modal');
            
            questoes.forEach(questao => {
                const titulo = questao.dataset.titulo.toLowerCase();
                const materia = questao.dataset.materia.toLowerCase();
                const tipo = questao.dataset.tipo.toLowerCase();
                
                if (titulo.includes(searchTerm) || materia.includes(searchTerm) || tipo.includes(searchTerm)) {
                    questao.style.display = 'block';
                } else {
                    questao.style.display = 'none';
                }
            });
        }

        function confirmarSelecaoQuestoes() {
            questoesSelecionadas = [...questoesSelecionadasTemp];
            atualizarPreview();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalSelecionarQuestoes'));
            modal.hide();
        }

        function removerQuestao(index) {
            questoesSelecionadas.splice(index, 1);
            atualizarPreview();
        }


        function atualizarPreview() {
    const container = document.getElementById('questoes-preview');
    
    if (questoesSelecionadas.length === 0) {
        container.innerHTML = `
            <p class="text-center text-muted">
                <i class="fas fa-info-circle"></i> 
                Adicione questões para visualizar o preview da prova
            </p>
        `;
        return;
    }

    let html = '';
    questoesSelecionadas.forEach((questao, index) => {
        const nivelAcessibilidade = questao.acessibilidade || 1;
        const temImagem = nivelAcessibilidade == 3 && (questao.imagem_gerada || questao.gerando_imagem);
        
        html += `
        <div class="questao-preview acessibilidade-${nivelAcessibilidade}">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6><strong>${index + 1}.</strong></h6>
                <button class="btn btn-sm btn-danger" onclick="removerQuestao(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        // Se tem imagem, usa layout horizontal
        if (temImagem) {
            html += `
            <div class="questao-conteudo-container">
                <div class="questao-texto-container">
                    <div class="mb-2">
                        <strong>${aplicarDestaquePalavras(questao.titulo, questao.materia, questao.acessibilidade)}</strong>
                    </div>
                    <div class="questao-opcoes-container">
            `;
            
            // Adiciona alternativas ou frases no container de texto
            if (questao.tipo === 'multipla' && questao.alternativas) {
                questao.alternativas.forEach((alt, altIndex) => {
                    const letra = String.fromCharCode(97 + altIndex);
                    html += `<div class="alternativa-item">${letra}) ${aplicarDestaquePalavras(alt.texto, questao.materia, questao.acessibilidade)}</div>`;
                });
            } else if (questao.tipo === 'vf' && questao.frases_vf) {
                questao.frases_vf.forEach(frase => {
                    html += `<div class="frase-vf-item">( ) ${aplicarDestaquePalavras(frase.texto, questao.materia, questao.acessibilidade)}</div>`;
                });
            } else if (questao.tipo === 'aberta') {
                html += `
                    <div class="linhas-resposta">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
                <div class="questao-imagem-container">
                    ${questao.gerando_imagem ? 
                        '<div class="gerando-imagem"><i class="fas fa-spinner fa-spin"></i><br>Gerando imagem...</div>' :
                        questao.imagem_gerada ? 
                            `<img src="${questao.imagem_gerada}" alt="Imagem da questão ${index + 1}" class="questao-imagem" />` :
                            '<div class="sem-imagem">Imagem será gerada</div>'
                    }
                </div>
            </div>
            `;
        } else {
            // Layout tradicional sem imagem
            html += `
            <div class="mb-2">
                <strong>${aplicarDestaquePalavras(questao.titulo, questao.materia, questao.acessibilidade)}</strong>
            </div>
            `;
            
            // Conteúdo específico por tipo
            if (questao.tipo === 'multipla' && questao.alternativas) {
                questao.alternativas.forEach((alt, altIndex) => {
                    const letra = String.fromCharCode(97 + altIndex);
                    html += `<div class="alternativa-item">${letra}) ${aplicarDestaquePalavras(alt.texto, questao.materia, questao.acessibilidade)}</div>`;
                });
            } else if (questao.tipo === 'vf' && questao.frases_vf) {
                questao.frases_vf.forEach(frase => {
                    html += `<div class="frase-vf-item">( ) ${aplicarDestaquePalavras(frase.texto, questao.materia, questao.acessibilidade)}</div>`;
                });
            } else if (questao.tipo === 'aberta') {
                html += `
                    <div class="linhas-resposta">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                `;
            }
        }

        // Seção de acessibilidade para cada questão
        html += `
            <div class="question-accessibility-section">
                <div class="accessibility-title">NÍVEL DE ACESSIBILIDADE DA QUESTÃO:</div>
                <div class="accessibility-options">
                    <div class="accessibility-option">
                        <input type="radio" id="questao_grupo1_${index}" name="acessibilidade_questao_${index}" value="1" ${nivelAcessibilidade == 1 ? 'checked' : ''} onchange="atualizarAcessibilidadeQuestao(${index}, 1)">
                        <label for="questao_grupo1_${index}">Grau 1</label>
                    </div>
                    <div class="accessibility-option">
                        <input type="radio" id="questao_grupo2_${index}" name="acessibilidade_questao_${index}" value="2" ${nivelAcessibilidade == 2 ? 'checked' : ''} onchange="atualizarAcessibilidadeQuestao(${index}, 2)">
                        <label for="questao_grupo2_${index}">Grau 2</label>
                    </div>
                    <div class="accessibility-option">
                        <input type="radio" id="questao_grupo3_${index}" name="acessibilidade_questao_${index}" value="3" ${nivelAcessibilidade == 3 ? 'checked' : ''} onchange="atualizarAcessibilidadeQuestao(${index}, 3)">
                        <label for="questao_grupo3_${index}">Grau 3</label>
                    </div>
                </div>
            </div>
        `;

        html += '</div>';
    });

    container.innerHTML = html;
}

    async function gerarImagemQuestao(questaoIndex) {
    const questao = questoesSelecionadas[questaoIndex];
    if (!questao) return;
    
    questao.gerando_imagem = true;
    atualizarPreview();
    
    try {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', getCSRFToken());
        formData.append('action', 'gerar_imagem_questao');
        formData.append('questao_dados', JSON.stringify(questao));
        
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            questao.imagem_gerada = data.imagem_url;
            questao.gerando_imagem = false;
            atualizarPreview();
        } else {
            throw new Error(data.error || 'Erro ao gerar imagem');
        }
        
    } catch (error) {
        console.error('Erro:', error);
        questao.gerando_imagem = false;
        atualizarPreview();
        alert('Erro ao gerar imagem: ' + error.message);
    }
}

// Função para gerar todas as imagens necessárias
async function gerarTodasImagensProva() {
    if (questoesSelecionadas.length === 0) {
        alert('Adicione questões à prova primeiro!');
        return;
    }
    
    const questoesNivel3 = questoesSelecionadas.filter(q => q.acessibilidade == 3);
    if (questoesNivel3.length === 0) {
        alert('Nenhuma questão com nível 3 de acessibilidade encontrada!');
        return;
    }
    
    showLoading();
    
    for (let i = 0; i < questoesSelecionadas.length; i++) {
        if (questoesSelecionadas[i].acessibilidade == 3 && !questoesSelecionadas[i].imagem_gerada) {
            await gerarImagemQuestao(i);
        }
    }
    
    hideLoading();
}

        function atualizarAcessibilidadeQuestao(index, nivel) {
    if (questoesSelecionadas[index]) {
        questoesSelecionadas[index].acessibilidade = nivel;
        // Atualizar preview quando mudar acessibilidade
        atualizarPreview();
    }
}
        function aplicarDestaquePalavras(texto, materia, nivelAcessibilidade) {
        // Só aplica destaque para graus 2 e 3
        if (!nivelAcessibilidade || nivelAcessibilidade == 1) {
            return texto;
        }
        
        const materiaLower = materia.toLowerCase();
        const palavras = palavrasChave[materiaLower] || [];
        
        let textoComDestaque = texto;
        palavras.forEach(palavra => {
            const regex = new RegExp(`\\b${palavra}\\b`, 'gi');
            textoComDestaque = textoComDestaque.replace(regex, `<span class="palavra-chave">$&</span>`);
        });
        
        return textoComDestaque;
    }
    
    function capturarConteudoPreview() {
    const titulo = document.getElementById('titulo').value || 'Título da Prova';
    const materia = document.getElementById('materia').value || 'Matéria';
    const tipoProva = document.getElementById('tipo_prova');
    const tipoTexto = tipoProva.options[tipoProva.selectedIndex]?.text || 'Tipo';
    
    // Capturar acessibilidade da prova
    const acessibilidadeProva = document.querySelector('input[name="acessibilidade_prova"]:checked')?.value || 1;
    
    // Montar o conteúdo HTML do preview
    let conteudoHTML = `
        <div class="prova-container">
            <div class="cabecalho-prova">
                <div class="info-prova">
                    <p><strong>Título da Prova:</strong> ${titulo}</p>
                    <p><strong>Matéria:</strong> ${materia}</p>
                    <p><strong>Tipo:</strong> ${tipoTexto}</p>
                    <p><strong>Nome:</strong> ___________________</p>
                    <p><strong>Data:</strong> ___________________</p>
                </div>
                <div class="acessibilidade-prova">
                    <p><strong>Nível de Acessibilidade da Prova: Grau ${acessibilidadeProva}</strong></p>
                </div>
            </div>
            <div class="questoes-container">
    `;
    
    // Adicionar cada questão formatada
    questoesSelecionadas.forEach((questao, index) => {
        const nivelAcessibilidade = questao.acessibilidade || 1;
        const temImagem = nivelAcessibilidade == 3 && questao.imagem;
        
        conteudoHTML += `
            <div class="questao acessibilidade-${nivelAcessibilidade}">
                <div class="questao-numero">
                    <h3>${index + 1}.</h3>
                </div>
        `;
        
        if (temImagem) {
            // Layout com imagem
            conteudoHTML += `
                <div class="questao-com-imagem">
                    <div class="questao-texto">
                        <p><strong>${aplicarDestaquePalavrasParaPDF(questao.titulo, questao.materia, questao.acessibilidade)}</strong></p>
            `;
            
            // Adicionar alternativas/frases
            if (questao.tipo === 'multipla' && questao.alternativas) {
                questao.alternativas.forEach((alt, altIndex) => {
                    const letra = String.fromCharCode(97 + altIndex);
                    conteudoHTML += `<p class="alternativa">${letra}) ${aplicarDestaquePalavrasParaPDF(alt.texto, questao.materia, questao.acessibilidade)}</p>`;
                });
            } else if (questao.tipo === 'vf' && questao.frases_vf) {
                questao.frases_vf.forEach(frase => {
                    conteudoHTML += `<p class="frase-vf">( ) ${aplicarDestaquePalavrasParaPDF(frase.texto, questao.materia, questao.acessibilidade)}</p>`;
                });
            } else if (questao.tipo === 'aberta') {
                conteudoHTML += `
                    <div class="linhas-resposta">
                        <p>_________________________________________________</p>
                        <p>_________________________________________________</p>
                        <p>_________________________________________________</p>
                    </div>
                `;
            }
            
            conteudoHTML += `
                    </div>
                    <div class="questao-imagem">
                        <img src="${questao.imagem_gerada || questao.imagem}" alt="Imagem da questão ${index + 1}" style="max-width: 300px; height: auto;" />
                    </div>
                </div>
            `;
        } else {
            // Layout sem imagem
            conteudoHTML += `
                <div class="questao-sem-imagem">
                    <p><strong>${aplicarDestaquePalavrasParaPDF(questao.titulo, questao.materia, questao.acessibilidade)}</strong></p>
            `;
            
            if (questao.tipo === 'multipla' && questao.alternativas) {
                questao.alternativas.forEach((alt, altIndex) => {
                    const letra = String.fromCharCode(97 + altIndex);
                    conteudoHTML += `<p class="alternativa">${letra}) ${aplicarDestaquePalavrasParaPDF(alt.texto, questao.materia, questao.acessibilidade)}</p>`;
                });
            } else if (questao.tipo === 'vf' && questao.frases_vf) {
                questao.frases_vf.forEach(frase => {
                    conteudoHTML += `<p class="frase-vf">( ) ${aplicarDestaquePalavrasParaPDF(frase.texto, questao.materia, questao.acessibilidade)}</p>`;
                });
            } else if (questao.tipo === 'aberta') {
                conteudoHTML += `
                    <div class="linhas-resposta">
                        <p>_________________________________________________</p>
                        <p>_________________________________________________</p>
                        <p>_________________________________________________</p>
                    </div>
                `;
            }
            
            conteudoHTML += `</div>`;
        }
        
        // Adicionar informação de acessibilidade da questão
        conteudoHTML += `
            <div class="acessibilidade-questao">
                <p><em>Nível de Acessibilidade da Questão: Grau ${nivelAcessibilidade}</em></p>
            </div>
        </div>
        `;
    });
    
    conteudoHTML += `
            </div>
        </div>
    `;
    
    return conteudoHTML;
}

// FUNÇÃO PARA APLICAR DESTAQUE DE PALAVRAS ESPECÍFICA PARA PDF
function aplicarDestaquePalavrasParaPDF(texto, materia, nivelAcessibilidade) {
    // Só aplica destaque para graus 2 e 3
    if (!nivelAcessibilidade || nivelAcessibilidade == 1) {
        return texto;
    }
    
    const materiaLower = materia.toLowerCase();
    const palavras = palavrasChave[materiaLower] || [];
    
    let textoComDestaque = texto;
    palavras.forEach(palavra => {
        const regex = new RegExp(`\\b${palavra}\\b`, 'gi');
        textoComDestaque = textoComDestaque.replace(regex, `<strong><u>$&</u></strong>`);
    });
    
    return textoComDestaque;
}


    async function salvarProva() {
    if (!validarFormulario()) return;

    try {
        showLoading();

        const formData = new FormData();
        
        // Adicionar CSRF Token
        const csrfToken = getCSRFToken();
        if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken);
        }
        
        // Dados do formulário
        formData.append('action', 'salvar_prova');
        formData.append('titulo', document.getElementById('titulo').value);
        formData.append('materia', document.getElementById('materia').value);
        formData.append('tipo_prova', document.getElementById('tipo_prova').value);
        
        // Nível de acessibilidade da prova
        const acessibilidadeProva = document.querySelector('input[name="acessibilidade_prova"]:checked')?.value || 1;
        formData.append('acessibilidade_prova', acessibilidadeProva);
        
        // Questões selecionadas com acessibilidade
        const questoesComAcessibilidade = questoesSelecionadas.map(questao => ({
            ...questao,
            acessibilidade: questao.acessibilidade || 1
        }));
        
        formData.append('questoes_selecionadas', JSON.stringify(questoesComAcessibilidade));

        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        });

        // Verificar se a resposta é JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            
            if (data.success) {
                alert('Prova salva com sucesso!');
            } else {
                alert('Erro ao salvar prova: ' + (data.error || 'Erro desconhecido'));
            }
        } else {
            // Se não for JSON, provavelmente é HTML (erro 403/404)
            const text = await response.text();
            console.error('Erro de servidor:', text);
            alert('Erro de servidor. Verifique se você está logado e tem permissão para esta ação.');
        }
        
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar prova: ' + error.message);
    } finally {
        hideLoading();
    }
}





        function validarFormulario() {
            const titulo = document.getElementById('titulo').value.trim();
            const materia = document.getElementById('materia').value.trim();
            const tipo = document.getElementById('tipo_prova').value;

            if (!titulo || !materia || !tipo) {
                alert('Preencha todos os campos obrigatórios!');
                return false;
            }

            if (questoesSelecionadas.length === 0) {
                alert('Adicione pelo menos uma questão à prova!');
                return false;
            }

            return true;
        }

        function abrirModalNovaQuestao() {
            const modal = new bootstrap.Modal(document.getElementById('modalNovaQuestao'));
            modal.show();
        }

        function toggleTipoQuestao() {
            const tipo = document.getElementById('nova-tipo').value;
            const alternativasSection = document.getElementById('alternativas-section');
            const vfSection = document.getElementById('vf-section');

            alternativasSection.style.display = 'none';
            vfSection.style.display = 'none';

            if (tipo === 'multipla') {
                alternativasSection.style.display = 'block';
            } else if (tipo === 'vf') {
                vfSection.style.display = 'block';
            }
        }

        function adicionarAlternativa() {
            const container = document.getElementById('alternativas-container');
            const count = container.children.length;
            const letra = String.fromCharCode(97 + count);
            
            const div = document.createElement('div');
            div.className = 'alternativa-input mb-2';
            div.innerHTML = `
                <div class="input-group">
                    <span class="input-group-text">${letra})</span>
                    <input type="text" class="form-control" name="alternativas[]" placeholder="Digite a alternativa">
                    <div class="input-group-text">
                        <input type="radio" name="correta" value="${count}" title="Marcar como correta">
                    </div>
                    <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function adicionarFrase() {
            const container = document.getElementById('frases-container');
            const div = document.createElement('div');
            div.className = 'frase-input mb-2';
            div.innerHTML = `
                <div class="input-group">
                    <input type="text" class="form-control" name="frases[]" placeholder="Digite a frase">
                    <select class="form-select" name="verdadeira[]" style="max-width: 120px;">
                        <option value="1">Verdadeiro</option>
                        <option value="0">Falso</option>
                    </select>
                    <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        async function salvarNovaQuestao() {
            // Implementar lógica para salvar nova questão
            alert('Funcionalidade de criar nova questão em desenvolvimento');
        }

        function showLoading() {
            document.querySelector('.loading').style.display = 'flex';
        }
        
        function hideLoading() {
            document.querySelector('.loading').style.display = 'none';
        }
    </script>
</body>
</html>